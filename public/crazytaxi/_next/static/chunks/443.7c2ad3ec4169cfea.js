"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[443],{1319:(e,t,r)=>{r.d(t,{BN:()=>i,d1:()=>o});let n=new Map;function o(){return n}function i(e){n=e}},2232:(e,t,r)=>{r.d(t,{W:()=>p});var n=r(5155),o=r(2115),i=r(9980),s=r(5339),c=r(3531),l=r(4510),a=r(1319),u=r(3946);function d(e){let{taxi:t,isPaused:r,deliveryColor:d}=e,p=(0,o.useRef)(null),h=(0,o.useRef)(null),f=(0,o.useRef)(new s.Pq0),m=(0,o.useRef)(Date.now()),{nodes:g,materials:y}=(0,c.p)((0,u.O)("models/taxi.glb")),x=o.useMemo(()=>t.path?(0,l.KQ)(t.path,t.t):new s.Pq0(0,-1e3,0),[]);return(0,i.D)((e,n)=>{if(!p.current||!t.path)return;let o=Math.min((Date.now()-m.current)/1e3/.5,1);if(h.current&&h.current.material instanceof s.imn&&(h.current.material.opacity=o),r)return;let i=(0,a.d1)();(0,l.E$)(t,+n,i);let c=(0,l.KQ)(t.path,t.t);if(p.current.position.copy(c),!f.current.equals(c)){let e=new s.Pq0().subVectors(c,f.current).normalize();if(e.length()>.01){let t=Math.atan2(e.x,e.z);p.current.rotation.y=t}}f.current.copy(c)}),(0,n.jsxs)("group",{ref:p,position:x,children:[(0,n.jsx)("mesh",{ref:h,geometry:g.taxi.geometry,material:y["colormap.013"],rotation:[Math.PI/2,0,0],scale:.297,castShadow:!0,renderOrder:10,children:(0,n.jsx)("meshStandardMaterial",{...y["colormap.013"],emissive:(()=>{switch(t.state){case"stopped":return"#ff0000";case"needs_service":return"#ff8800";case"broken":return"#440000";default:return"#000000"}})(),emissiveIntensity:.5,transparent:!0,opacity:0})}),t.hasPackage&&d&&(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("pointLight",{position:[0,.3,0],color:d,intensity:3,distance:1,decay:3})})]})}function p(e){let{taxisRef:t,deliveriesRef:r,isPaused:s}=e,[,c]=(0,o.useState)(0);(0,i.D)(()=>{c(e=>e+1)});let l=t.current,a=r.current;return(0,n.jsx)("group",{children:l.map(e=>{if(!e.isReady)return null;let t=a.find(t=>t.id===e.currentDeliveryId);return(0,n.jsx)(d,{taxi:e,isPaused:s,deliveryColor:null==t?void 0:t.color},e.id)})})}c.p.preload((0,u.O)("models/taxi.glb"))},2324:(e,t,r)=>{r.d(t,{m:()=>c});var n=r(2115),o=r(9980),i=r(5339);function s(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}function c(e){let{taxisRef:t,followTaxiId:r}=e;return!function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,{camera:t}=(0,o.C)(),r=(0,n.useRef)(new Set);(0,n.useEffect)(()=>{let e=e=>{let t=e.key.toLowerCase();["w","a","s","d"].includes(t)&&r.current.add(t)},t=e=>{let t=e.key.toLowerCase();r.current.delete(t)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[]),(0,o.D)((n,o)=>{let{controls:s}=n,c=e*o,l=new i.Pq0;t.getWorldDirection(l),l.y=0,l.normalize();let a=new i.Pq0;a.crossVectors(l,new i.Pq0(0,1,0)),a.normalize();let u=new i.Pq0;r.current.has("w")&&u.add(l.clone().multiplyScalar(c)),r.current.has("s")&&u.add(l.clone().multiplyScalar(-c)),r.current.has("a")&&u.add(a.clone().multiplyScalar(-c)),r.current.has("d")&&u.add(a.clone().multiplyScalar(c)),u.length()>0&&(t.position.add(u),s&&"target"in s&&s.target.add(u))})}(10),!function(e){let{taxisRef:t,followTaxiId:r,lerpSpeed:c=2.5}=e,{camera:l}=(0,o.C)(),a=(0,n.useRef)(new i.Pq0),u=(0,n.useRef)(new i.Pq0(0,1,5)),d=(0,n.useRef)(new i.Pq0(0,20,15)),p=(0,n.useRef)(!1),h=(0,n.useRef)(!1),f=(0,n.useRef)(0),m=(0,n.useRef)(!1),g=(0,n.useRef)(new i.Pq0),y=(0,n.useRef)(new i.Pq0);(0,o.D)((e,n)=>{let{controls:o}=e;if(!o||!("target"in o))return;let x=o.target;if(p.current||(x.copy(u.current),p.current=!0),r){let e=t.current.find(e=>e.id===r);if(!e||!e.path)return;let o=e.path.points;if(o.length<2)return;let u=1/(o.length-1),d=Math.floor(e.t/u),p=e.t%u/u,w=o[Math.min(d,o.length-2)],v=o[Math.min(d+1,o.length-1)],M=w.clone().lerp(v,p);h.current||(f.current=0,m.current=!0,h.current=!0,g.current.copy(l.position),y.current.copy(x));let j=new i.Pq0(-5,8,-5),b=M.clone().add(j);if(m.current)if(f.current+=n,f.current<1.5){let e=s(Math.min(f.current/1.5,1));l.position.lerpVectors(g.current,b,e),x.lerpVectors(y.current,M,e)}else m.current=!1,x.lerp(M,c*n);else x.lerp(M,c*n);a.current.copy(M)}else if(h.current&&(h.current=!1,f.current=0,m.current=!0,g.current.copy(l.position),y.current.copy(x)),m.current)if(f.current+=n,f.current<1.5){let e=s(Math.min(f.current/1.5,1));l.position.lerpVectors(g.current,d.current,e),x.lerpVectors(y.current,u.current,e)}else m.current=!1,l.position.copy(d.current),x.copy(u.current)})}({taxisRef:t,followTaxiId:r,lerpSpeed:4}),null}},5503:(e,t,r)=>{r.d(t,{I:()=>y});var n=r(5155),o=r(2115),i=r(9980),s=r(5339),c=r(3946),l=r(3531),a=r(598);let u={1:(0,c.O)("models/box_small.glb"),2:(0,c.O)("models/box_large.glb"),3:(0,c.O)("models/box_long.glb"),4:(0,c.O)("models/box_wide.glb")},d=(0,c.O)("models/arrow_chevron.glb"),p=(0,c.O)("models/arrow.glb");function h(e){let{position:t,dropoffPosition:r,color:c,deliveryId:h,multiplier:f,distance:m}=e,g=(0,o.useRef)(null),y=(0,o.useRef)(0),x=(0,o.useMemo)(()=>u[Math.min(4,Math.max(1,Math.floor(f)))],[f]),w=(0,o.useMemo)(()=>(console.log("distance",m),m>8?p:d),[m]),{scene:v}=(0,l.p)(x),{scene:M}=(0,l.p)(w),j=(0,o.useMemo)(()=>v.clone(),[v]),b=(0,o.useMemo)(()=>{let e=M.clone();return e.traverse(e=>{if(e.isMesh&&e.material){let t=e.material.clone();t.color=new s.Q1f(c),t.emissive=new s.Q1f(c),t.emissiveIntensity=.8,t.transparent=!0,t.opacity=.5,e.material=t}}),e},[M,c]),D=(0,o.useMemo)(()=>{let e=new s.Pq0().subVectors(r,t).normalize(),n=new s.PTz,o=new s.Pq0(-1,0,0);return n.setFromUnitVectors(o,e),{position:new s.Pq0(0,1,0),quaternion:n}},[t,r]);return(0,i.D)((e,r)=>{if(!g.current)return;y.current+=r;let n=.08*Math.sin(2*y.current)+1;g.current.scale.set(n,n,n);let o=.1*Math.sin(1.5*y.current);g.current.position.y=t.y+.4+o}),(0,n.jsxs)("group",{ref:g,position:[t.x,t.y,t.z],children:[(0,n.jsx)("primitive",{object:j}),(0,n.jsx)("group",{position:D.position,quaternion:D.quaternion,scale:.7,children:(()=>{let e=.5*m/3;return Array.from({length:3}).map((t,r)=>(0,n.jsx)("group",{position:[-e+-e*r,.2*r-.5,0],children:(0,n.jsx)(a.i,{object:b})},r))})()})]})}function f(e){let{position:t,color:r,opacity:c=.9}=e,l=(0,o.useRef)(null),a=(0,o.useRef)(null),u=(0,o.useRef)(null),d=(0,o.useRef)(null),p=(0,o.useRef)(0);return(0,i.D)((e,t)=>{p.current+=t;let r=.15*Math.sin(2*p.current)+1;l.current&&l.current.scale.set(r,r,r),a.current&&a.current.scale.set(r,r,r),u.current&&u.current.scale.set(r,r,r),d.current&&(d.current.scale.set(r,r,r),d.current.material.opacity=(.25*Math.sin(2*p.current)+.45)*c)}),(0,n.jsxs)("group",{position:[t.x,t.y,t.z],children:[(0,n.jsxs)("mesh",{ref:d,position:[0,.2,0],rotation:[-Math.PI/2,0,0],children:[(0,n.jsx)("torusGeometry",{args:[.8,.06,8,32]}),(0,n.jsx)("meshBasicMaterial",{color:r,transparent:!0,opacity:.9*c,side:s.$EB,depthWrite:!1})]}),(0,n.jsxs)("mesh",{ref:l,position:[0,.4,0],rotation:[Math.PI/2,0,0],children:[(0,n.jsx)("torusGeometry",{args:[.6,.04,8,32]}),(0,n.jsx)("meshStandardMaterial",{color:r,emissive:r,emissiveIntensity:.8,transparent:!0,opacity:.6*c})]}),(0,n.jsxs)("mesh",{ref:a,position:[0,.6,0],rotation:[Math.PI/2,0,0],children:[(0,n.jsx)("torusGeometry",{args:[.3,.03,8,32]}),(0,n.jsx)("meshStandardMaterial",{color:r,emissive:r,emissiveIntensity:1,transparent:!0,opacity:.8*c})]}),(0,n.jsx)("pointLight",{position:[0,.5,0],color:r,intensity:3,distance:2,decay:2})]})}Object.values(u).forEach(e=>{l.p.preload(e)}),l.p.preload(d),l.p.preload(p);let m={1:(0,c.O)("models/box_small.glb"),2:(0,c.O)("models/box_large.glb"),3:(0,c.O)("models/box_long.glb"),4:(0,c.O)("models/box_wide.glb")};function g(e){let{taxiPosition:t,deliveryId:r,multiplier:s}=e,c=(0,o.useRef)(null),a=(0,o.useRef)(0),u=(0,o.useMemo)(()=>m[Math.min(4,Math.max(1,Math.floor(s)))],[s]),{scene:d}=(0,l.p)(u),p=(0,o.useMemo)(()=>d.clone(),[d]);return(0,i.D)((e,r)=>{if(!c.current)return;a.current+=r,c.current.rotation.y=a.current;let n=.1*Math.sin(4*a.current);c.current.position.set(t.x,t.y+.8+n,t.z)}),(0,n.jsx)("group",{ref:c,scale:.8,children:(0,n.jsx)("primitive",{object:p})})}function y(e){let{deliveriesRef:t,pickupNodesRef:r,taxisRef:s}=e,[,c]=(0,o.useState)(0);(0,i.D)(()=>{c(e=>e+1)});let l=t.current,a=r.current,u=s.current;return(0,n.jsxs)("group",{children:[l.filter(e=>"waiting_pickup"===e.status).map(e=>{let t=a.find(t=>t.id===e.pickupNodeId),r=a.find(t=>t.id===e.dropoffNodeId);return t&&r?(0,n.jsx)(h,{position:t.position,dropoffPosition:r.position,color:e.color,deliveryId:e.id,multiplier:e.multiplier,distance:e.distance},"pickup-".concat(e.id)):null}),l.filter(e=>"in_transit"===e.status).map(e=>{let t=a.find(t=>t.id===e.dropoffNodeId);return t?(0,n.jsx)(f,{position:t.position,color:e.color,opacity:1},"dropoff-".concat(e.id)):null}),u.filter(e=>e.hasPackage&&e.path&&e.currentDeliveryId).map(e=>{let t=e.path.points;if(t.length<2)return null;let r=1/(t.length-1),o=Math.floor(e.t/r),i=e.t%r/r,s=t[Math.min(o,t.length-2)],c=t[Math.min(o+1,t.length-1)],a=s.clone().lerp(c,i),u=l.find(t=>t.id===e.currentDeliveryId);return u?(0,n.jsx)(g,{taxiPosition:a,color:u.color,deliveryId:u.id,multiplier:u.multiplier},"package-".concat(e.id)):null})]})}Object.values(m).forEach(e=>{l.p.preload(e)})},7381:(e,t,r)=>{r.d(t,{h:()=>h});var n=r(5155),o=r(2115),i=r(3646),s=r(9074),c=r(3804),l=r(9559);function a(e){let{position:t,mode:r,onClick:a}=e,u=(0,o.useMemo)(()=>{switch(r){case"pass_through":return"#00ff00";case"turn_left":return"#ffff00";case"turn_right":return"#0088ff"}},[r]),d=(0,o.useMemo)(()=>{switch(r){case"pass_through":return s.A;case"turn_left":return c.A;case"turn_right":return l.A}},[r]);return(0,n.jsxs)("group",{position:[t.x,t.y+.5,t.z],onClick:e=>{e.stopPropagation(),a()},onPointerOver:e=>{e.stopPropagation(),document.body.style.cursor="pointer"},onPointerOut:()=>{document.body.style.cursor="default"},children:[(0,n.jsxs)("mesh",{position:[0,-.44,0],rotation:[-Math.PI/2,0,0],renderOrder:-10,children:[(0,n.jsx)("circleGeometry",{args:[1,32]}),(0,n.jsx)("meshBasicMaterial",{color:u,transparent:!0,opacity:.15,depthTest:!1,depthWrite:!1})]}),(0,n.jsx)("group",{position:[0,-.2,0],children:(0,n.jsx)(i.E,{center:!0,distanceFactor:10,zIndexRange:[100,0],style:{pointerEvents:"none",userSelect:"none"},children:(0,n.jsx)("div",{style:{animation:"turn_left"===r?"spinLeft 6s linear infinite":"turn_right"===r?"spinRight 6s linear infinite":"none"},children:(0,n.jsx)(d,{size:100,color:u,fill:"none",strokeWidth:2,opacity:.6,style:{filter:"drop-shadow(0 0 8px ".concat(u,")"),display:"block"}})})})})]})}var u=r(5304),d=r(8946),p=r(1319);function h(){let{intersections:e,toggleIntersectionMode:t}=function(){let[e,t]=(0,o.useState)(new Map);(0,o.useEffect)(()=>{let e=(0,d.nt)(),r=(0,u.vL)(e.nodes,"intersection"),n=new Map;r.forEach(t=>{let r=e.paths.filter(e=>e.id.startsWith("".concat(t.id,"_to_"))).map(e=>e.id),o=!1;if(t.neighbors){let e=t.neighbors.filter(e=>null!==e).length;(o=e>=2)&&console.log("  \uD83D\uDCCD ".concat(t.id," [TOPO]: ").concat(e," neighbors → creating controls"))}else r.length>1&&(o=!0,console.log("  \uD83D\uDCCD ".concat(t.id," [LEGACY]: ").concat(r.length," paths → creating controls")));o?n.set(t.id,{nodeId:t.id,mode:"pass_through",availablePaths:r}):console.log("  ⚠️ ".concat(t.id,": Not enough connections for intersection controls"))}),t(n),(0,p.BN)(n),console.log("\uD83D\uDEA6 Initialized ".concat(n.size," intersections with controllable routing")),n.forEach((e,t)=>{console.log("  \uD83D\uDCCD ".concat(t,": ").concat(e.availablePaths.length," exits, mode: ").concat(e.mode))})},[]);let r=(0,o.useCallback)(e=>{t(t=>{let r=new Map(t),n=r.get(e);if(!n)return console.warn("⚠️ No intersection state for ".concat(e)),t;let o="pass_through"===n.mode?"turn_left":"turn_left"===n.mode?"turn_right":"pass_through";return r.set(e,{...n,mode:o}),(0,p.BN)(r),console.log("\uD83D\uDEA6 ".concat(e," mode changed: ").concat(n.mode," → ").concat(o)),r})},[]),n=(0,o.useCallback)((e,r)=>{t(t=>{let n=new Map(t),o=n.get(e);return o?(n.set(e,{...o,mode:r}),(0,p.BN)(n),console.log("\uD83D\uDEA6 ".concat(e," mode set to: ").concat(r)),n):(console.warn("⚠️ No intersection state for ".concat(e)),t)})},[]),i=(0,o.useCallback)(t=>{var r;return(null==(r=e.get(t))?void 0:r.mode)||"pass_through"},[e]),s=(0,o.useCallback)(()=>Array.from(e.entries()).map(e=>{let[,t]=e;return{...t}}),[e]);return{intersections:e,toggleIntersectionMode:r,setIntersectionMode:n,getMode:i,getIntersectionList:s}}(),r=(0,o.useMemo)(()=>(0,d.nt)(),[]);return(0,n.jsx)("group",{name:"intersection-manager",children:Array.from(e.entries()).map(e=>{let[o,i]=e,s=r.nodes.find(e=>e.id===o);return s?(0,n.jsx)(a,{position:s.position,mode:i.mode,onClick:()=>t(o)},o):(console.warn("⚠️ Intersection node ".concat(o," not found in network")),null)})})}},9809:(e,t,r)=>{r.d(t,{C:()=>i});var n=r(9980),o=r(8774);function i(e){let{deliveriesRef:t,deliveryTimerRef:r,pickupNodesRef:i,taxisRef:s,isPaused:c,isRushHour:l}=e;return(0,n.D)((e,n)=>{if(c)return;if(r.current-=1e3*n,r.current<=0){if(console.log("⏰ Delivery spawn timer expired! Pickup nodes available: ".concat(i.current.length," ").concat(l?"\uD83D\uDEA6 RUSH HOUR":"")),i.current.length>=2){let e=(0,o.aK)(i.current,t.current);e&&(t.current.push(e),console.log("\uD83D\uDCE6 Spawned delivery ".concat(e.id,": ").concat(e.pickupNodeId," → ").concat(e.dropoffNodeId," [").concat(e.color,"]")),console.log("   Total active deliveries: ".concat(t.current.length)))}else console.warn("⚠️ Not enough pickup nodes (need 2, have ".concat(i.current.length,")"));r.current=l?5e3:1e4}let a=(0,o.WF)(s.current,t.current,i.current);a.length>0&&(console.log("✅ Removing ".concat(a.length," completed deliveries:"),a),t.current=t.current.filter(e=>!a.includes(e.id)),console.log("   Remaining active deliveries: ".concat(t.current.length)))}),null}}}]);