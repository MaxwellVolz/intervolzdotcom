"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[737],{1319:(e,t,n)=>{n.d(t,{BN:()=>s,d1:()=>o});let r=new Map;function o(){return r}function s(e){r=e}},2232:(e,t,n)=>{n.d(t,{W:()=>d});var r=n(5155),o=n(2115),s=n(3646),i=n(5339),a=n(3531),l=n(4510),c=n(1319);function u(e){let{taxi:t,isPaused:n,deliveryColor:u}=e,d=(0,o.useRef)(null),p=(0,o.useRef)(null),h=(0,o.useRef)(new i.Pq0),g=(0,o.useRef)(Date.now()),{nodes:f,materials:m}=(0,a.p)("/models/taxi.glb");return(0,s.D)((e,r)=>{if(!d.current||!t.path)return;let o=Math.min((Date.now()-g.current)/1e3/.5,1);if(p.current&&p.current.material instanceof i.imn&&(p.current.material.opacity=o),n)return;let s=(0,c.d1)();(0,l.E$)(t,+r,s);let a=(0,l.KQ)(t.path,t.t);if(d.current.position.copy(a),!h.current.equals(a)){let e=new i.Pq0().subVectors(a,h.current).normalize();if(e.length()>.01){let t=Math.atan2(e.x,e.z);d.current.rotation.y=t}}h.current.copy(a)}),(0,r.jsxs)("group",{ref:d,children:[(0,r.jsx)("mesh",{ref:p,geometry:f.taxi.geometry,material:m["colormap.013"],rotation:[Math.PI/2,0,0],scale:.297,castShadow:!0,renderOrder:10,children:(0,r.jsx)("meshStandardMaterial",{...m["colormap.013"],emissive:(()=>{switch(t.state){case"stopped":return"#ff0000";case"needs_service":return"#ff8800";case"broken":return"#440000";default:return"#000000"}})(),emissiveIntensity:.5,transparent:!0,opacity:0})}),t.hasPackage&&u&&(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("pointLight",{position:[0,.3,0],color:u,intensity:3,distance:1,decay:3})})]})}function d(e){let{taxisRef:t,deliveriesRef:n,isPaused:i}=e,[,a]=(0,o.useState)(0);(0,s.D)(()=>{a(e=>e+1)});let l=t.current,c=n.current;return(0,r.jsx)("group",{children:l.map(e=>{let t=c.find(t=>t.id===e.currentDeliveryId);return(0,r.jsx)(u,{taxi:e,isPaused:i,deliveryColor:null==t?void 0:t.color},e.id)})})}a.p.preload("/models/taxi.glb")},2324:(e,t,n)=>{n.d(t,{m:()=>i});var r=n(2115),o=n(3646),s=n(5339);function i(e){let{taxisRef:t,followTaxiId:n}=e;return!function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,{camera:t}=(0,o.C)(),n=(0,r.useRef)(new Set);(0,r.useEffect)(()=>{let e=e=>{let t=e.key.toLowerCase();["w","a","s","d"].includes(t)&&n.current.add(t)},t=e=>{let t=e.key.toLowerCase();n.current.delete(t)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[]),(0,o.D)((r,o)=>{let{controls:i}=r,a=e*o,l=new s.Pq0;t.getWorldDirection(l),l.y=0,l.normalize();let c=new s.Pq0;c.crossVectors(l,new s.Pq0(0,1,0)),c.normalize();let u=new s.Pq0;n.current.has("w")&&u.add(l.clone().multiplyScalar(a)),n.current.has("s")&&u.add(l.clone().multiplyScalar(-a)),n.current.has("a")&&u.add(c.clone().multiplyScalar(-a)),n.current.has("d")&&u.add(c.clone().multiplyScalar(a)),u.length()>0&&(t.position.add(u),i&&"target"in i&&i.target.add(u))})}(10),!function(e){let{taxisRef:t,followTaxiId:n,lerpSpeed:i=2.5}=e,{camera:a}=(0,o.C)(),l=(0,r.useRef)(new s.Pq0),c=(0,r.useRef)(new s.Pq0(.5,0,-.5)),u=(0,r.useRef)(new s.Pq0(8,10,8)),d=(0,r.useRef)(!1),p=(0,r.useRef)(!1),h=(0,r.useRef)(0),g=(0,r.useRef)(0),f=(0,r.useRef)(!1);(0,o.D)((e,r)=>{let{controls:o}=e;if(!o||!("target"in o))return;let m=o.target;if(d.current||(m.copy(c.current),d.current=!0),n){let e=t.current.find(e=>e.id===n);if(!e||!e.path)return;let o=e.path.points;if(o.length<2)return;let c=1/(o.length-1),u=Math.floor(e.t/c),d=e.t%c/c,g=o[Math.min(u,o.length-2)],f=o[Math.min(u+1,o.length-1)],y=g.clone().lerp(f,d);p.current||(h.current=0,p.current=!0),h.current+=r;let D=new s.Pq0(-5,8,-5),x=y.clone().add(D);if(h.current<1){let e=i*(1+2*Math.min(h.current/1,1));a.position.lerp(x,e*r),m.lerp(y,e*r)}else m.lerp(y,i*r);l.current.copy(y)}else if(p.current&&(p.current=!1,h.current=0,g.current=0,f.current=!0),f.current)if(g.current+=r,g.current<1){let e=i*(1+2*Math.min(g.current/1,1));a.position.lerp(u.current,e*r),m.lerp(c.current,e*r)}else f.current=!1,m.copy(c.current)})}({taxisRef:t,followTaxiId:n,lerpSpeed:4}),null}},5304:(e,t,n)=>{n.d(t,{V1:()=>o,Xm:()=>i,vL:()=>s});var r=n(5339);function o(e){let t=[];if(e.scene.traverse(e=>{if(e.name.startsWith("PathNode_")||e.name.startsWith("INT_")||e.name.startsWith("Pickup_")||e.name.startsWith("Dropoff_")||e.userData&&(e.userData.north||e.userData.east||e.userData.south||e.userData.west||e.userData.neighbors||e.userData.next_nodes)){let n,o,s=new r.Pq0;if(e.getWorldPosition(s),e.userData&&(e.userData.north||e.userData.east||e.userData.south||e.userData.west)){let t=e.userData.north?String(e.userData.north).trim():null,n=e.userData.east?String(e.userData.east).trim():null,r=e.userData.south?String(e.userData.south).trim():null,s=e.userData.west?String(e.userData.west).trim():null;o=[t||null,n||null,r||null,s||null],console.log("  \uD83D\uDCCD ".concat(e.name," [TOPO-SPLIT] → N:").concat(t||"-",", E:").concat(n||"-",", S:").concat(r||"-",", W:").concat(s||"-"))}else if(e.userData&&e.userData.neighbors)try{let t=e.userData.neighbors;if("string"==typeof t){let n;t.trim().startsWith("[")&&t.trim().endsWith("]")?(n=(n=t.trim().slice(1,-1)).replace(/"/g,"").replace(/'/g,""),console.log("  \uD83D\uDCCD ".concat(e.name,' [JSON format] → parsing: "').concat(n,'"'))):n=t,o=n.split(",").map(e=>{let t=e.trim();return""===t?null:t}),4!==o.length&&(console.warn("⚠️ ".concat(e.name," neighbors should have 4 slots, got ").concat(o.length)),o=[...o,null,null,null,null].slice(0,4)),console.log("  \uD83D\uDCCD ".concat(e.name," [TOPO-STRING] → neighbors:"),o)}}catch(t){console.error("❌ Failed to parse neighbors for ".concat(e.name,":"),t),console.error("   Raw value:",e.userData.neighbors)}if(!o&&e.userData&&e.userData.next_nodes)try{let t=e.userData.next_nodes;"string"==typeof t?(n=JSON.parse(t),console.log("  \uD83D\uDCCD ".concat(e.name," [LEGACY] → next_nodes parsed:"),n)):Array.isArray(t)&&(n=t,console.log("  \uD83D\uDCCD ".concat(e.name," [LEGACY] → next_nodes array:"),n))}catch(t){console.error("❌ Failed to parse next_nodes for ".concat(e.name,":"),t),console.error("   Raw value:",e.userData.next_nodes)}o||n||console.log("  ⚠️ ".concat(e.name," has NO neighbors or next_nodes property"));let i=function(e){let t=[],n=e.toLowerCase();return n.includes("intersection")&&t.push("intersection"),n.includes("pickup")&&t.push("pickup"),n.includes("dropoff")&&t.push("dropoff"),(n.includes("redlight")||n.includes("red_light"))&&t.push("red_light"),n.includes("service")&&t.push("service"),0===t.length&&t.push("path"),t}(e.name);if((e.name.startsWith("INT_")||e.name.toLowerCase().includes("intersection"))&&o){let t=o.filter(e=>null!==e).length;t>=2&&!i.includes("intersection")&&(i.push("intersection"),console.log("  \uD83D\uDEA6 ".concat(e.name," detected as intersection (").concat(t," neighbors)")))}t.push({id:e.name,position:s,next:n,neighbors:o,types:i,metadata:e.userData})}}),t.sort((e,t)=>e.id.localeCompare(t.id)),t.filter(e=>!e.neighbors&&(!e.next||0===e.next.length)).length===t.length){console.log("\uD83D\uDCCD No connections defined in Blender, auto-connecting sequential nodes (legacy mode)...");let e=t.filter(e=>e.types.includes("path")||e.types.includes("intersection"));for(let n=0;n<e.length-1;n++){let r=t.find(t=>t.id===e[n].id);r&&!r.neighbors&&(r.next||(r.next=[]),r.next.push(e[n+1].id))}if(e.length>0){let n=t.find(t=>t.id===e[e.length-1].id);n&&!n.neighbors&&(n.next||(n.next=[]),n.next.push(e[0].id))}}return t}function s(e,t){return e.filter(e=>e.types.includes(t))}function i(e,t){return e.types.includes(t)}},7381:(e,t,n)=>{n.d(t,{h:()=>h});var r=n(5155),o=n(2115),s=n(1265),i=n(9074),a=n(3804),l=n(9559);function c(e){let{position:t,mode:n,onClick:c}=e,u=(0,o.useMemo)(()=>{switch(n){case"pass_through":return"#00ff00";case"turn_left":return"#ffff00";case"turn_right":return"#0088ff"}},[n]),d=(0,o.useMemo)(()=>{switch(n){case"pass_through":return i.A;case"turn_left":return a.A;case"turn_right":return l.A}},[n]);return(0,r.jsxs)("group",{position:[t.x,t.y+.5,t.z],onClick:e=>{e.stopPropagation(),c()},onPointerOver:e=>{e.stopPropagation(),document.body.style.cursor="pointer"},onPointerOut:()=>{document.body.style.cursor="default"},children:[(0,r.jsxs)("mesh",{position:[0,-.44,0],rotation:[-Math.PI/2,0,0],renderOrder:-10,children:[(0,r.jsx)("circleGeometry",{args:[1,32]}),(0,r.jsx)("meshBasicMaterial",{color:u,transparent:!0,opacity:.15,depthTest:!1,depthWrite:!1})]}),(0,r.jsx)("group",{position:[0,-.2,0],children:(0,r.jsxs)(s.E,{center:!0,distanceFactor:10,zIndexRange:[100,0],style:{pointerEvents:"none",userSelect:"none"},children:[(0,r.jsx)("div",{style:{animation:"turn_left"===n?"spinLeft 6s linear infinite":"turn_right"===n?"spinRight 6s linear infinite":"none"},children:(0,r.jsx)(d,{size:100,color:u,fill:"none",strokeWidth:2,opacity:.8,style:{filter:"drop-shadow(0 0 8px ".concat(u,")"),display:"block"}})}),(0,r.jsx)("style",{children:"\n            @keyframes spinLeft {\n              from { transform: rotate(0deg); }\n              to { transform: rotate(-360deg); }\n            }\n            @keyframes spinRight {\n              from { transform: rotate(0deg); }\n              to { transform: rotate(360deg); }\n            }\n          "})]})})]})}var u=n(5304),d=n(8946),p=n(1319);function h(){let{intersections:e,toggleIntersectionMode:t}=function(){let[e,t]=(0,o.useState)(new Map);(0,o.useEffect)(()=>{let e=(0,d.nt)(),n=(0,u.vL)(e.nodes,"intersection"),r=new Map;n.forEach(t=>{let n=e.paths.filter(e=>e.id.startsWith("".concat(t.id,"_to_"))).map(e=>e.id),o=!1;if(t.neighbors){let e=t.neighbors.filter(e=>null!==e).length;(o=e>=2)&&console.log("  \uD83D\uDCCD ".concat(t.id," [TOPO]: ").concat(e," neighbors → creating controls"))}else n.length>1&&(o=!0,console.log("  \uD83D\uDCCD ".concat(t.id," [LEGACY]: ").concat(n.length," paths → creating controls")));o?r.set(t.id,{nodeId:t.id,mode:"pass_through",availablePaths:n}):console.log("  ⚠️ ".concat(t.id,": Not enough connections for intersection controls"))}),t(r),(0,p.BN)(r),console.log("\uD83D\uDEA6 Initialized ".concat(r.size," intersections with controllable routing")),r.forEach((e,t)=>{console.log("  \uD83D\uDCCD ".concat(t,": ").concat(e.availablePaths.length," exits, mode: ").concat(e.mode))})},[]);let n=(0,o.useCallback)(e=>{t(t=>{let n=new Map(t),r=n.get(e);if(!r)return console.warn("⚠️ No intersection state for ".concat(e)),t;let o="pass_through"===r.mode?"turn_left":"turn_left"===r.mode?"turn_right":"pass_through";return n.set(e,{...r,mode:o}),(0,p.BN)(n),console.log("\uD83D\uDEA6 ".concat(e," mode changed: ").concat(r.mode," → ").concat(o)),n})},[]),r=(0,o.useCallback)((e,n)=>{t(t=>{let r=new Map(t),o=r.get(e);return o?(r.set(e,{...o,mode:n}),(0,p.BN)(r),console.log("\uD83D\uDEA6 ".concat(e," mode set to: ").concat(n)),r):(console.warn("⚠️ No intersection state for ".concat(e)),t)})},[]),s=(0,o.useCallback)(t=>{var n;return(null==(n=e.get(t))?void 0:n.mode)||"pass_through"},[e]),i=(0,o.useCallback)(()=>Array.from(e.entries()).map(e=>{let[,t]=e;return{...t}}),[e]);return{intersections:e,toggleIntersectionMode:n,setIntersectionMode:r,getMode:s,getIntersectionList:i}}(),n=(0,d.nt)();return e.size>0&&console.log("\uD83D\uDEA6 IntersectionManager: Rendering ".concat(e.size," intersection tiles")),(0,r.jsx)("group",{name:"intersection-manager",children:Array.from(e.entries()).map(e=>{let[o,s]=e,i=n.nodes.find(e=>e.id===o);return i?(0,r.jsx)(c,{position:i.position,mode:s.mode,onClick:()=>t(o)},o):(console.warn("⚠️ Intersection node ".concat(o," not found in network")),null)})})}},9809:(e,t,n)=>{n.d(t,{C:()=>s});var r=n(3646),o=n(8774);function s(e){let{deliveriesRef:t,deliveryTimerRef:n,pickupNodesRef:s,taxisRef:i,isPaused:a,isRushHour:l}=e;return(0,r.D)((e,r)=>{if(a)return;if(n.current-=1e3*r,n.current<=0){if(console.log("⏰ Delivery spawn timer expired! Pickup nodes available: ".concat(s.current.length," ").concat(l?"\uD83D\uDEA6 RUSH HOUR":"")),s.current.length>=2){let e=(0,o.aK)(s.current,t.current);e&&(t.current.push(e),console.log("\uD83D\uDCE6 Spawned delivery ".concat(e.id,": ").concat(e.pickupNodeId," → ").concat(e.dropoffNodeId," [").concat(e.color,"]")),console.log("   Total active deliveries: ".concat(t.current.length)))}else console.warn("⚠️ Not enough pickup nodes (need 2, have ".concat(s.current.length,")"));n.current=l?5e3:1e4}let c=(0,o.WF)(i.current,t.current,s.current);c.length>0&&(console.log("✅ Removing ".concat(c.length," completed deliveries:"),c),t.current=t.current.filter(e=>!c.includes(e.id)),console.log("   Remaining active deliveries: ".concat(t.current.length)))}),null}},9957:(e,t,n)=>{n.d(t,{I:()=>g});var r=n(5155),o=n(2115),s=n(3646),i=n(3531);let a=["/models/present_white_cube.glb","/models/present_green_round.glb","/models/present_green_rectangle.glb","/models/present_green_cube.glb","/models/present_white_round.glb","/models/present_white_rectangle.glb"];function l(e){let{position:t,color:n,deliveryId:l}=e,c=(0,o.useRef)(null),u=(0,o.useRef)(0),d=(0,o.useMemo)(()=>a[l.split("").reduce((e,t)=>e+t.charCodeAt(0),0)%a.length],[l]),{scene:p}=(0,i.p)(d),h=(0,o.useMemo)(()=>p.clone(),[p]);return(0,s.D)((e,n)=>{if(!c.current)return;u.current+=n;let r=.08*Math.sin(2*u.current)+1;c.current.scale.set(r,r,r);let o=.1*Math.sin(1.5*u.current);c.current.position.y=t.y+.4+o}),(0,r.jsxs)("group",{ref:c,position:[t.x,t.y+.4,t.z],children:[(0,r.jsx)("primitive",{object:h}),(0,r.jsxs)("mesh",{position:[0,.2,0],children:[(0,r.jsx)("sphereGeometry",{args:[.6,16,16]}),(0,r.jsx)("meshStandardMaterial",{color:n,emissive:n,emissiveIntensity:1.5,transparent:!0,opacity:.5,depthWrite:!1})]})]})}a.forEach(e=>{i.p.preload(e)});var c=n(5339);function u(e){let{position:t,color:n,opacity:i=.9}=e,a=(0,o.useRef)(null),l=(0,o.useRef)(null),u=(0,o.useRef)(null),d=(0,o.useRef)(null),p=(0,o.useRef)(0);return(0,s.D)((e,t)=>{p.current+=t;let n=.15*Math.sin(2*p.current)+1;a.current&&a.current.scale.set(n,n,n),l.current&&l.current.scale.set(n,n,n),u.current&&u.current.scale.set(n,n,n),d.current&&(d.current.scale.set(n,n,n),d.current.material.opacity=(.25*Math.sin(2*p.current)+.45)*i)}),(0,r.jsxs)("group",{position:[t.x,t.y,t.z],children:[(0,r.jsxs)("mesh",{ref:d,position:[0,.2,0],rotation:[-Math.PI/2,0,0],children:[(0,r.jsx)("torusGeometry",{args:[.8,.06,8,32]}),(0,r.jsx)("meshBasicMaterial",{color:n,transparent:!0,opacity:.9*i,side:c.$EB,depthWrite:!1})]}),(0,r.jsxs)("mesh",{ref:a,position:[0,.4,0],rotation:[Math.PI/2,0,0],children:[(0,r.jsx)("torusGeometry",{args:[.6,.04,8,32]}),(0,r.jsx)("meshStandardMaterial",{color:n,emissive:n,emissiveIntensity:.8,transparent:!0,opacity:.6*i})]}),(0,r.jsxs)("mesh",{ref:l,position:[0,.6,0],rotation:[Math.PI/2,0,0],children:[(0,r.jsx)("torusGeometry",{args:[.3,.03,8,32]}),(0,r.jsx)("meshStandardMaterial",{color:n,emissive:n,emissiveIntensity:1,transparent:!0,opacity:.8*i})]}),(0,r.jsx)("pointLight",{position:[0,.5,0],color:n,intensity:3,distance:2,decay:2})]})}let d=["/models/present_white_cube.glb","/models/present_green_round.glb","/models/present_green_rectangle.glb","/models/present_green_cube.glb","/models/present_white_round.glb","/models/present_white_rectangle.glb"];function p(e){let{taxiPosition:t,deliveryId:n}=e,a=(0,o.useRef)(null),l=(0,o.useRef)(0),c=(0,o.useMemo)(()=>d[n.split("").reduce((e,t)=>e+t.charCodeAt(0),0)%d.length],[n]),{scene:u}=(0,i.p)(c),p=(0,o.useMemo)(()=>u.clone(),[u]);return(0,s.D)((e,n)=>{if(!a.current)return;l.current+=n,a.current.rotation.y=l.current;let r=.1*Math.sin(4*l.current);a.current.position.set(t.x,t.y+.8+r,t.z)}),(0,r.jsx)("group",{ref:a,scale:.8,children:(0,r.jsx)("primitive",{object:p})})}function h(e){let{pickupPosition:t,dropoffPosition:n,color:s,opacity:i=.5}=e,a=(0,o.useMemo)(()=>{let e=new c.Pq0(t.x,t.y+.4,t.z),r=new c.Pq0(n.x,n.y+.4,n.z),o=(t.x+n.x)/2,s=(t.z+n.z)/2,a=Math.min(.3*t.distanceTo(n),3),l=new c.Pq0(o,Math.max(t.y,n.y)+.4+a,s),u=[];for(let t=0;t<15;t++){let n=t/14,o=new c.Pq0;o.x=Math.pow(1-n,2)*e.x+2*(1-n)*n*l.x+Math.pow(n,2)*r.x,o.y=Math.pow(1-n,2)*e.y+2*(1-n)*n*l.y+Math.pow(n,2)*r.y,o.z=Math.pow(1-n,2)*e.z+2*(1-n)*n*l.z+Math.pow(n,2)*r.z;let s=i*Math.pow(1-n,1.1);u.push({position:o,opacity:s})}return u},[t,n,i]);return(0,r.jsx)("group",{children:a.map((e,t)=>(0,r.jsxs)("mesh",{position:e.position,children:[(0,r.jsx)("sphereGeometry",{args:[.15,8,8]}),(0,r.jsx)("meshStandardMaterial",{color:s,emissive:s,emissiveIntensity:.5,transparent:!0,opacity:e.opacity})]},t))})}function g(e){let{deliveriesRef:t,pickupNodesRef:n,taxisRef:i}=e,[,a]=(0,o.useState)(0);(0,s.D)(()=>{a(e=>e+1)});let c=t.current,d=n.current,g=i.current;return(0,r.jsxs)("group",{children:[c.filter(e=>"waiting_pickup"===e.status).map(e=>{let t=d.find(t=>t.id===e.pickupNodeId);return t?(0,r.jsx)(l,{position:t.position,color:e.color,deliveryId:e.id},"pickup-".concat(e.id)):null}),c.filter(e=>"waiting_pickup"===e.status).map(e=>{let t=d.find(t=>t.id===e.pickupNodeId),n=d.find(t=>t.id===e.dropoffNodeId);return t&&n?(0,r.jsx)(h,{pickupPosition:t.position,dropoffPosition:n.position,color:e.color,opacity:.5},"path-".concat(e.id)):null}),c.filter(e=>"in_transit"===e.status).map(e=>{let t=d.find(t=>t.id===e.dropoffNodeId);return t?(0,r.jsx)(u,{position:t.position,color:e.color,opacity:1},"dropoff-".concat(e.id)):null}),g.filter(e=>e.hasPackage&&e.path&&e.currentDeliveryId).map(e=>{let t=e.path.points;if(t.length<2)return null;let n=1/(t.length-1),o=Math.floor(e.t/n),s=e.t%n/n,i=t[Math.min(o,t.length-2)],a=t[Math.min(o+1,t.length-1)],l=i.clone().lerp(a,s),u=c.find(t=>t.id===e.currentDeliveryId);if(!u)return null;let d=u.color,h=u.id;return(0,r.jsx)(p,{taxiPosition:l,color:d,deliveryId:h},"package-".concat(e.id))})]})}d.forEach(e=>{i.p.preload(e)})}}]);